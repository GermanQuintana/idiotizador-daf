<!doctype html>
<html lang="gl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Idiotizador PRO (DAF)</title>
  <meta name="theme-color" content="#111111" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; line-height: 1.35; background: #f4f4f4; color: #111; }
    .card { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 20px; max-width: 760px; margin: 0 auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    h2 { margin-top: 0; }
    label { display:block; margin-top: 18px; font-weight: 700; font-size: 0.95rem; }
    input[type="range"] { width: 100%; margin-top: 8px; cursor: pointer; }
    
    .row { display:flex; gap:12px; flex-wrap: wrap; align-items:center; margin-bottom: 20px; }
    .row > div { flex: 1 1 180px; }
    
    button { padding: 12px 14px; border-radius: 10px; border: none; background: #111; color: #fff; font-weight: 800; cursor: pointer; width: 100%; transition: opacity 0.2s; }
    button.secondary { background: #e0e0e0; color:#111; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button:active { transform: scale(0.98); }
    
    .warn { margin-top: 15px; color: #d32f2f; font-weight: 700; background: #ffebee; padding: 10px; border-radius: 8px; font-size: 0.9rem; }
    .muted { color: #666; font-size: 0.9rem; }
    .pill { display:inline-block; padding: 4px 10px; background:#eee; border-radius: 999px; font-size: 0.85rem; font-weight: 600; }
    #errBox { margin-top: 12px; padding: 10px; border: 1px solid #f36; background: #fff0f3; border-radius: 10px; white-space: pre-wrap; color: #d00; }
  </style>
</head>
<body>
  <div class="card">
    <h2>üéß Idiotizador PRO</h2>
    <p class="muted">
      Fala e escoita a t√∫a voz cun retardo extremo. <br>
      <b>Usa auriculares</b> obrigatoriamente para que funcione ben.
    </p>

    <div class="row">
      <div><button id="startBtn">‚ñ∂Ô∏è INICIAR</button></div>
      <div><button id="stopBtn" class="secondary" disabled>‚èπ PARAR</button></div>
      <div style="text-align:center;"><span class="pill" id="status">Estado: parado</span></div>
    </div>
    <div class="row" style="margin-top: -10px;">
       <div><button id="unlockBtn" class="secondary" style="font-size:0.8rem; padding: 8px;">üîì Desbloquear (iPhone/Safari)</button></div>
    </div>

    <label>‚è±Ô∏è Retardo: <span id="delayMsLabel">200</span> ms</label>
    <input id="delayMs" type="range" min="0" max="2000" step="10" value="200" />

    <label>üîÑ Rebotes (Feedback): <span id="feedbackLabel">40%</span></label>
    <input id="feedback" type="range" min="0" max="0.9" step="0.05" value="0.4" />

    <label>üîä Volume Sa√≠da: <span id="outGainLabel">0.80</span></label>
    <input id="outGain" type="range" min="0" max="1.5" step="0.05" value="0.80" />

    <label>üéöÔ∏è Mestura (Wet/Dry): <span id="mixLabel">100%</span> Voz retardada</label>
    <input id="mix" type="range" min="0" max="1" step="0.05" value="1" />

    <div class="warn">
        ‚ö†Ô∏è <b>Consello:</b> Sube o "Retardo" a 600-800ms e os "Rebotes" ao 60% para m√°xima confusi√≥n.
    </div>
    <div id="errBox" style="display:none;"></div>
  </div>

<script>
  let audioCtx = null;
  let stream = null;
  let source = null;

  // Nodos de audio
  let delayNode = null;
  let feedbackGainNode = null; // Nodo nuevo para el feedback
  let wetGain = null;
  let dryGain = null;
  let outGainNode = null;

  let running = false;

  const $ = (id) => document.getElementById(id);

  function setStatus(txt) { $("status").textContent = txt; }

  function showErr(msg) {
    const box = $("errBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  function clearErr() {
    $("errBox").style.display = "none";
    $("errBox").textContent = "";
  }

  function applyUI() {
    if (!audioCtx) return;

    const delayMs = parseFloat($("delayMs").value);
    const feedbackVal = parseFloat($("feedback").value);
    const outGain = parseFloat($("outGain").value);
    const mix = parseFloat($("mix").value);

    // Actualizar etiquetas visuales
    $("delayMsLabel").textContent = delayMs.toFixed(0);
    $("feedbackLabel").textContent = Math.round(feedbackVal * 100) + "%";
    $("outGainLabel").textContent = outGain.toFixed(2);
    $("mixLabel").textContent = Math.round(mix * 100) + "%";

    const currentTime = audioCtx.currentTime;

    // Aplicar valores al audio
    if (delayNode) delayNode.delayTime.setTargetAtTime(delayMs / 1000.0, currentTime, 0.05);
    if (feedbackGainNode) feedbackGainNode.gain.setTargetAtTime(feedbackVal, currentTime, 0.05);
    if (outGainNode) outGainNode.gain.setTargetAtTime(outGain, currentTime, 0.05);
    
    if (wetGain) wetGain.gain.setTargetAtTime(mix, currentTime, 0.05);
    if (dryGain) dryGain.gain.setTargetAtTime(1.0 - mix, currentTime, 0.05);
  }

  async function ensureAudioContext() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)({
        latencyHint: "interactive" // Prioriza baja latencia
      });
    }
    if (audioCtx.state !== "running") {
      await audioCtx.resume();
    }
  }

  async function start() {
    if (running) return;
    clearErr();

    if (!navigator.mediaDevices?.getUserMedia) {
      throw new Error("O navegador non soporta acceso ao micr√≥fono.");
    }

    await ensureAudioContext();

    try {
        // Pedir micr√≥fono
        stream = await navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: false, // Importante: OFF para que no filtre el efecto
                noiseSuppression: false,
                autoGainControl: false,
                latency: 0
            }
        });
    } catch (e) {
        // Fallback para dispositivos restrictivos
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }

    source = audioCtx.createMediaStreamSource(stream);

    // Crear nodos
    // Max delay subido a 5.0 segundos por seguridad (aunque usemos 2s en UI)
    delayNode = audioCtx.createDelay(5.0); 
    feedbackGainNode = audioCtx.createGain();
    wetGain = audioCtx.createGain();
    dryGain = audioCtx.createGain();
    outGainNode = audioCtx.createGain();
    
    // Compresor para evitar picos muy fuertes con el feedback
    const compressor = audioCtx.createDynamicsCompressor();
    compressor.threshold.value = -20;
    compressor.knee.value = 40;
    compressor.ratio.value = 12;

    // CONEXIONES (Ruteo de cables):
    
    // 1. Ruta DRY (voz directa)
    source.connect(dryGain);
    dryGain.connect(outGainNode);

    // 2. Ruta WET (efecto delay + feedback)
    source.connect(delayNode);           // Mic -> Delay
    delayNode.connect(wetGain);          // Delay -> Wet Mixer
    
    // Bucle de Feedback: Delay -> FeedbackGain -> Delay
    delayNode.connect(feedbackGainNode);
    feedbackGainNode.connect(delayNode);

    // Salida final
    wetGain.connect(compressor);         // Pasamos lo mojado por compresor
    compressor.connect(outGainNode);     // Compresor -> Salida general
    outGainNode.connect(audioCtx.destination);

    applyUI(); // Aplicar valores iniciales de los sliders

    running = true;
    $("startBtn").disabled = true;
    $("stopBtn").disabled = false;
    setStatus("ACTIVO üî¥");
  }

  function stop() {
    if (!running) return;
    
    // Desconectar todo suavemente
    if (source) source.disconnect();
    if (delayNode) delayNode.disconnect();
    if (feedbackGainNode) feedbackGainNode.disconnect();
    
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    
    running = false;
    $("startBtn").disabled = false;
    $("stopBtn").disabled = true;
    setStatus("PARADO");
  }

  // Event Listeners
  $("unlockBtn").addEventListener("click", async () => {
    try { await ensureAudioContext(); setStatus("Audio Desbloqueado"); } catch(e) {}
  });

  $("startBtn").addEventListener("click", async () => {
    try { await start(); } catch (e) { showErr("Erro: " + e.message); stop(); }
  });

  $("stopBtn").addEventListener("click", stop);

  ["delayMs", "feedback", "outGain", "mix"].forEach(id => {
    $(id).addEventListener("input", applyUI);
  });
</script>
</body>
</html>
